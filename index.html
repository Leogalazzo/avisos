<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mas que Burgers - Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #ffc107;
            --whatsapp: #25d366;
            --dark: #1a1a1a;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center; 
            background: #f0f2f5; 
            margin: 0;
            padding: 20px;
            color: var(--dark);
            /* Evita rebote en iOS */
            overscroll-behavior-y: contain;
        }

        .container { max-width: 500px; margin: auto; }

        h2 { margin-bottom: 15px; font-size: 1.5rem; }

        /* Contenedor de video con guia */
        .video-wrapper {
            position: relative;
            width: 100%;
            /* Hacemos un contenedor cuadrado o casi cuadrado para el video */
            aspect-ratio: 3/4; 
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        #video {
            width: 100%;
            height: 100%;
            /* Esto asegura que el video llene el contenedor sin estirarse raro */
            object-fit: cover; 
        }

        /* Gu√≠a visual para centrar el n√∫mero */
        .scanner-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 70px;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            /* Un peque√±o truco para oscurecer alrededor de la gu√≠a */
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .controls { 
            margin-top: 25px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }

        button { 
            padding: 16px; 
            font-size: 18px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s;
            /* Evita doble tap zoom en el boton */
            touch-action: manipulation;
        }

        button:active { transform: scale(0.96); opacity: 0.9; }

        .btn-scan { background: var(--primary); color: #000; }
        .btn-wa { background: var(--whatsapp); color: white; display: none; font-size: 16px;}
        
        #output { 
            margin: 15px 0; 
            font-size: 1.1em; 
            min-height: 24px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Estado cargando */
        .scanning { opacity: 0.7; cursor: not-allowed; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Mas que Burgers üçîüçü</h2>
        
        <div class="video-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div class="scanner-guide"></div>
        </div>
        
        <canvas id="canvas"></canvas>

        <div class="controls">
            <button id="scanBtn" class="btn-scan" onclick="captureAndScan()">üì∑ ESCANEAR N√öMERO</button>
            
            <div id="output">Encuadra el n√∫mero en el recuadro.</div>
            
            <button id="btn5min" class="btn-wa" onclick="sendWA('5min')">‚è≥ En 5 min est√° listo</button>
            <button id="btnReady" class="btn-wa" onclick="sendWA('ready')">‚úÖ ¬°Ya est√° listo!</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const output = document.getElementById('output');
        const scanBtn = document.getElementById('scanBtn');
        let detectedNumber = "";
        let isScanning = false;

        // --- CORRECCI√ìN AQU√ç ---
        // 1. Iniciar C√°mara (Modo simple, sin forzar resoluci√≥n)
        // Pedimos "environment" (trasera) y dejamos que el navegador decida.
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: { ideal: "environment" }
            } 
        })
        .then(stream => { 
            video.srcObject = stream; 
            // Esperamos a que el video tenga datos para ajustar el canvas
            video.onloadedmetadata = () => {
                 canvas.width = video.videoWidth;
                 canvas.height = video.videoHeight;
            };
        })
        .catch(err => {
            alert("Error: No se pudo acceder a la c√°mara trasera. Aseg√∫rate de dar permisos y usar HTTPS.");
            output.innerText = "‚ö†Ô∏è C√°mara no disponible.";
        });


        // 2. Capturar y Procesar con OCR
        async function captureAndScan() {
            if (isScanning || !video.srcObject) return;

            isScanning = true;
            scanBtn.innerText = "Procesando... ‚è≥";
            scanBtn.classList.add('scanning');
            output.innerText = "Analizando imagen...";
            
            const context = canvas.getContext('2d');
            // Aseguramos que el canvas tenga el tama√±o del video actual
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // Tesseract analiza el canvas. Usamos el modelo 'eng' (ingl√©s) que funciona bien para n√∫meros.
                const result = await Tesseract.recognize(canvas, 'eng', {
                    // Opcional: Logger para ver el progreso en consola
                    // logger: m => console.log(m) 
                });
                
                const text = result.data.text;
                
                // Limpieza del texto: extraemos solo los d√≠gitos
                // Usamos una expresi√≥n regular que busca grupos de 8 o m√°s d√≠gitos juntos
                const textCleaned = text.replace(/[^0-9\n]/g, ''); // Dejar solo n√∫meros y saltos de linea
                
                // Buscamos la secuencia de n√∫meros m√°s larga que parezca un celular
                let possibleNumbers = textCleaned.match(/\d{8,12}/g); 
                
                if (possibleNumbers && possibleNumbers.length > 0) {
                    // Tomamos el primer n√∫mero v√°lido encontrado
                    let rawNumber = possibleNumbers[0];

                    // --- L√ìGICA DE PA√çS (Ajustar si es necesario) ---
                    // Si detecta 10 d√≠gitos (ej. 11 1234 5678), asumimos que es Argentina y agregamos 54
                    if (rawNumber.length === 10 && !rawNumber.startsWith('54')) {
                        detectedNumber = "54" + rawNumber;
                    } else {
                        detectedNumber = rawNumber;
                    }
                    
                    output.innerHTML = `‚úÖ Detectado: <strong>${detectedNumber}</strong>`;
                    document.getElementById('btn5min').style.display = 'block';
                    document.getElementById('btnReady').style.display = 'block';
                    // Vibrar si el celular lo soporta para confirmar escaneo
                    if (navigator.vibrate) navigator.vibrate(200);

                } else {
                    output.innerHTML = "‚ö†Ô∏è No se encontr√≥ un n√∫mero claro.<br><small>Intenta acercar y centrar el n√∫mero.</small>";
                }
            } catch (e) {
                console.error(e);
                output.innerText = "Error t√©cnico en el escaneo. Reintent√°.";
            }

            isScanning = false;
            scanBtn.innerText = "üì∑ ESCANEAR DE NUEVO";
            scanBtn.classList.remove('scanning');
        }

        // 3. Funci√≥n para enviar los mensajes predeterminados
        function sendWA(type) {
            let msg = "";
            const footer = "\n\nMas que Burgersüçîüçü";
            
            if (type === '5min') {
                msg = "Buenas noches. En 5 minutos va a estar listo su pedido." + footer;
            } else {
                msg = "Buenas noches. Ya esta listo tu pedido‚òëÔ∏è" + footer;
            }

            // Abrimos WhatsApp con el n√∫mero y el texto codificado
            const url = `https://wa.me/${detectedNumber}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
